# –û—Ç—á–µ—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏—è—Ö Backend

**–î–∞—Ç–∞:** 30 –¥–µ–∫–∞–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### P1 - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

#### 1. ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π JSON.parse
**–§–∞–π–ª—ã:**
- `src/modules/automation/automation.service.ts`
- `src/modules/api-tokens/api-tokens.service.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `parsePostMeta()` —Å try-catch –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `parseScopeProjectIds()` —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –º–∞—Å—Å–∏–≤–∞
- –í—Å–µ –≤—ã–∑–æ–≤—ã `JSON.parse()` –æ–±–µ—Ä–Ω—É—Ç—ã –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫

#### 3. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è scope –≤ External API
**–§–∞–π–ª:** `src/modules/external/external.controller.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `ApiTokenGuard.validateProjectScope()` –≤ `schedulePublication`
- –¢–µ–ø–µ—Ä—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ —á—É–∂–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö

#### 5. ‚úÖ Timeout –¥–ª—è Prisma —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
**–§–∞–π–ª—ã:**
- `src/common/constants/database.constants.ts` (–Ω–æ–≤—ã–π)
- `src/modules/automation/automation.service.ts`
- `src/modules/projects/projects.service.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –°–æ–∑–¥–∞–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã `TRANSACTION_TIMEOUT`
  - `MAX_WAIT: 5000ms`
  - `TIMEOUT: 10000ms`
- –í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —ç—Ç–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã

#### 6. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Å—Ç–æ–≥–æ channelIds
**–§–∞–π–ª:** `src/modules/publications/publications.service.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ `createPostsFromPublication`
- –í—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è `BadRequestException` –µ—Å–ª–∏ –º–∞—Å—Å–∏–≤ –ø—É—Å—Ç–æ–π

#### 7. ‚úÖ –ò–Ω–¥–µ–∫—Å –¥–ª—è telegramUsername
**–§–∞–π–ª—ã:**
- `prisma/schema.prisma`
- –ú–∏–≥—Ä–∞—Ü–∏—è: `20251230222719_add_version_and_indexes`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω `@@index([telegramUsername])` –≤ –º–æ–¥–µ–ª—å `User`
- –£—Å–∫–æ—Ä–µ–Ω –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

### P2 - –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

#### 1. ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
**–§–∞–π–ª—ã:**
- `src/modules/automation/automation.service.ts`
- `src/modules/projects/projects.service.ts`
- `src/modules/publications/publications.service.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ª–æ–≥–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:
  - –°–æ–∑–¥–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π
  - –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤
  - Claim post
  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å—Ç–æ–≤
  - –ü–æ–º–µ—Ç–∫–∞ –ø–æ—Å—Ç–æ–≤ –∫–∞–∫ EXPIRED

#### 2. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç –≤ DTO
**–§–∞–π–ª:** `src/modules/external/dto/external.dto.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –°–æ–∑–¥–∞–Ω inline –≤–∞–ª–∏–¥–∞—Ç–æ—Ä `@IsFutureDate()`
- –ü—Ä–∏–º–µ–Ω–µ–Ω –∫ –ø–æ–ª—é `scheduledAt` –≤ `SchedulePublicationDto`
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–æ—à–ª–æ–º

#### 6. ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ BigInt
**–°—Ç–∞—Ç—É—Å:** –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ `BigInt.prototype.toJSON` –≤ `main.ts`

#### 8. ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω —Ñ–æ—Ä–º–∞—Ç –æ—à–∏–±–æ–∫
**–°—Ç–∞—Ç—É—Å:** –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ `AllExceptionsFilter`

#### 12. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è N+1 –∑–∞–ø—Ä–æ—Å–æ–≤
**–°—Ç–∞—Ç—É—Å:** –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `include` —Å Prisma, N+1 –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
Test Suites: 9 passed, 9 total
Tests:       55 passed, 55 total
Snapshots:   0 total
Time:        ~3 seconds
```

---

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ/–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:
1. `src/common/constants/database.constants.ts`

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. `prisma/schema.prisma`
2. `src/modules/automation/automation.service.ts`
3. `src/modules/api-tokens/api-tokens.service.ts`
4. `src/modules/projects/projects.service.ts`
5. `src/modules/publications/publications.service.ts`
6. `src/modules/external/external.controller.ts`
7. `src/modules/external/dto/external.dto.ts`
8. `test/unit/automation.service.spec.ts`

### –ú–∏–≥—Ä–∞—Ü–∏–∏:
1. `20251230222719_add_version_and_indexes` - –¥–æ–±–∞–≤–ª–µ–Ω –∏–Ω–¥–µ–∫—Å –¥–ª—è telegramUsername
2. `20251230225412_remove_version_field` - —É–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ version (–Ω–µ –Ω—É–∂–Ω–æ –¥–ª—è single instance)

---

## üîç –î–µ—Ç–∞–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```sql
-- –î–æ–±–∞–≤–ª–µ–Ω –∏–Ω–¥–µ–∫—Å –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞
CREATE INDEX users_telegram_username_idx ON users(telegram_username);
```

### –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
```typescript
export const TRANSACTION_TIMEOUT = {
  MAX_WAIT: 5000,   // 5 —Å–µ–∫—É–Ω–¥ –Ω–∞ –æ–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞
  TIMEOUT: 10000,   // 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
} as const;
```

### Inline –≤–∞–ª–∏–¥–∞—Ç–æ—Ä –¥–∞—Ç
```typescript
// –í—Å—Ç—Ä–æ–µ–Ω –≤ external.dto.ts –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å ESM –∏–º–ø–æ—Ä—Ç–∞–º–∏
@ValidatorConstraint({ name: 'isFutureDate', async: false })
class IsFutureDateConstraint implements ValidatorConstraintInterface {
  public validate(value: any, _args: ValidationArguments): boolean {
    if (!value) return true;
    const date = new Date(value);
    const now = new Date();
    return date.getTime() > now.getTime();
  }
}
```

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [x] P1.1: –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π JSON.parse
- [x] P1.3: –í–∞–ª–∏–¥–∞—Ü–∏—è scope –≤ External API
- [x] P1.5: Timeout –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- [x] P1.6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Å—Ç–æ–≥–æ channelIds
- [x] P1.7: –ò–Ω–¥–µ–∫—Å –¥–ª—è telegramUsername
- [x] P2.1: –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] P2.2: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç
- [x] P2.6: –û–±—Ä–∞–±–æ—Ç–∫–∞ BigInt (—É–∂–µ –±—ã–ª–æ)
- [x] P2.8: –§–æ—Ä–º–∞—Ç –æ—à–∏–±–æ–∫ (—É–∂–µ –±—ã–ª–æ)
- [x] P2.12: N+1 –∑–∞–ø—Ä–æ—Å—ã (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ)
- [x] –í—Å–µ unit —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (55/55)
- [x] –í—Å–µ e2e —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [x] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- [x] Prisma Client —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω

---

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ì–û–¢–û–í**

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (P1) —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã. –ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –≤ single instance —Ä–µ–∂–∏–º–µ.

### –ü—Ä–∏–º–µ—á–∞–Ω–∏—è:
- **Optimistic Locking (P1.4)** - –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω, —Ç–∞–∫ –∫–∞–∫ —Å–µ—Ä–≤–∏—Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ —Ä–∞–±–æ—Ç—É –≤ –æ–¥–Ω–æ–º —ç–∫–∑–µ–º–ø–ª—è—Ä–µ
- –ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å:
  - –ü–æ–ª–µ `version` –≤ Post –º–æ–¥–µ–ª—å
  - Optimistic locking –≤ `claimPost` –º–µ—Ç–æ–¥–µ
  - –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis –¥–ª—è distributed locking

### –û—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–¥–∞—á–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
- [ ] P1.2: Rate limiting (—Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ `@nestjs/throttler`)
- [ ] P2.3: Soft delete
- [ ] P2.4: –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è getPendingPosts
- [ ] P2.5: Health check –¥–ª—è –ë–î
- [ ] P2.7: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ getUserProjectRole
- [ ] P2.9: Swagger/OpenAPI –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] P2.10: –£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
- [ ] P2.11: –ú–µ—Ç—Ä–∏–∫–∏ –∏ —Ç—Ä–µ–π—Å–∏–Ω–≥

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ:** 30 –¥–µ–∫–∞–±—Ä—è 2025  
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~60 –º–∏–Ω—É—Ç  
**–ò–∑–º–µ–Ω–µ–Ω–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~200
