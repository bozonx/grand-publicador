# API для внешних сервисов (External & Automation)

Этот документ описывает API endpoints, предназначенные для интеграции с внешними системами автоматизации (например, n8n, Zapier) и для работы внутренних воркеров (Automation).

## Аутентификация

Все запросы к этому API должны быть защищены с использованием API ключа.

- **Заголовок (Header):** `x-api-key: <ВАШ_API_КЛЮЧ>`
- **Альтернативный заголовок:** `Authorization: Bearer <ВАШ_API_КЛЮЧ>`

Ключ задается в переменной окружения `API_KEY`.

---

## 1. Внешняя интеграция (External)

Эндпоинты для создания и планирования публикаций из внешних источников.

### Создание публикации
Создает новую публикацию (черновик или готовую) в указанном проекте.

**Endpoint:** `POST /api/external/publications`

**Тело запроса (JSON):**

| Поле | Тип | Обязательно | Описание |
|---|---|---|---|
| `projectId` | String | Да | ID проекта, в котором создается публикация. |
| `title` | String | Нет | Заголовок публикации. |
| `content` | String | Да | Основной текст публикации. |
| `mediaFiles` | String[] | Нет | Массив ссылок на медиа-файлы (изображения, видео). |
| `tags` | String | Нет | Теги одной строкой (формат зависит от реализации UI, обычно CSV). |
| `status` | String | Нет | Статус публикации (`DRAFT`, `SCHEDULED`, `PUBLISHED`). По умолчанию `DRAFT`. |

**Пример (n8n HTTP Request):**
```json
{
  "projectId": "uuid-project-id",
  "title": "Новости дня",
  "content": "Сегодня произошло важное событие...",
  "mediaFiles": ["https://example.com/image.jpg"],
  "tags": "news,tech",
  "status": "DRAFT"
}
```

### Планирование публикации (Рассылка)
Создает посты для конкретных каналов на основе уже созданной публикации.

**Endpoint:** `POST /api/external/publications/schedule`

**Тело запроса (JSON):**

| Поле | Тип | Обязательно | Описание |
|---|---|---|---|
| `publicationId` | String | Да | ID исходной публикации. |
| `channelIds` | String[] | Да | Массив ID каналов, в которые нужно отправить пост. |
| `scheduledAt` | ISO Date | Нет | Дата и время запланированной публикации. Если не указано, создаются черновики (или публикуется сразу в зависимости от логики). |

**Пример:**
```json
{
  "publicationId": "uuid-publication-id",
  "channelIds": ["uuid-channel-1", "uuid-channel-2"],
  "scheduledAt": "2024-01-01T12:00:00Z"
}
```

---

## 2. API Автоматизации (Automation)

Эндпоинты, используемые фоновыми воркерами или скриптами автоматизации для обработки очереди публикаций.

### Получение списка ожидающих постов
Получает список постов, готовых к публикации (статус, время публикации наступило).

**Endpoint:** `GET /api/automation/v1/posts/pending`

**Параметры URL:**
- `limit` (int, default: 10): Максимальное количество постов.
- `lookback` (int, default: 60): Окно поиска в прошлом (минуты/часы, см. код), чтобы не забирать слишком старые "зависшие" посты бесконечно.

**Ответ:** Массив объектов Post.

### Захват поста (Claim)
"Блокирует" пост для обработки конкретным воркером, чтобы избежать дублирования публикации. Атомарная операция.

**Endpoint:** `POST /api/automation/v1/posts/:id/claim`

### Обновление статуса поста
Обновляет статус поста после попытки публикации (успех или ошибка).

**Endpoint:** `PATCH /api/automation/v1/posts/:id/status`

**Тело запроса (JSON):**

| Поле | Тип | Обязательно | Описание |
|---|---|---|---|
| `status` | String | Да | Новый статус: `PUBLISHED` или `FAILED`. |
| `error` | String | Нет | Описание ошибки, если публикация не удалась. |

**Пример:**
```json
{
  "status": "PUBLISHED"
}
```
или
```json
{
  "status": "FAILED",
  "error": "Timeout connecting to Telegram API"
}
```
