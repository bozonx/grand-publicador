# API для внешних интеграций

Этот документ описывает использование API для внешних систем автоматизации (например, n8n, Zapier) и для работы внутренних воркеров.

## Аутентификация

Все эндпоинты API поддерживают два метода аутентификации:

### 1. JWT токен (для фронтенда)
```
Authorization: Bearer <JWT_TOKEN>
```

### 2. API токен (для внешних интеграций)
```
x-api-key: <API_TOKEN>
```
или
```
Authorization: Bearer <API_TOKEN>
```

**Как создать API токен:**
1. Войдите в приложение
2. Перейдите в Настройки (Settings)
3. В разделе "API Tokens" создайте новый токен
4. При создании вы можете ограничить доступ токена только к определённым проектам (scope)

**Область доступа (Scope):**
- Если при создании токена не выбраны конкретные проекты, токен имеет доступ ко всем вашим проектам
- Если выбраны определённые проекты, токен может работать только с ними
- Попытка доступа к проекту вне области токена вернёт ошибку 403 Forbidden

---

## Основные эндпоинты

### Создание поста
Создает новый пост в указанном канале.

**Endpoint:** `POST /api/v1/posts`

**Тело запроса (JSON):**

| Поле | Тип | Обязательно | Описание |
|---|---|---|---|
| `channelId` | String | Да | ID канала, в котором создается пост. |
| `content` | String | Да | Основной текст поста. |
| `mediaFiles` | String[] | Нет | Массив ссылок на медиа-файлы (изображения, видео). |
| `scheduledAt` | ISO Date | Нет | Дата и время запланированной публикации. |
| `status` | String | Нет | Статус поста (`DRAFT`, `SCHEDULED`, `PUBLISHED`). По умолчанию `DRAFT`. |

**Пример (n8n HTTP Request):**
```json
{
  "channelId": "uuid-channel-id",
  "content": "Сегодня произошло важное событие...",
  "mediaFiles": ["https://example.com/image.jpg"],
  "scheduledAt": "2024-01-01T12:00:00Z",
  "status": "SCHEDULED"
}
```

### Создание публикации
Создает новую публикацию (черновик или готовую) в указанном проекте.

**Endpoint:** `POST /api/v1/publications`

**Тело запроса (JSON):**

| Поле | Тип | Обязательно | Описание |
|---|---|---|---|
| `projectId` | String | Да | ID проекта, в котором создается публикация. |
| `title` | String | Нет | Заголовок публикации. |
| `content` | String | Да | Основной текст публикации. |
| `mediaFiles` | String[] | Нет | Массив ссылок на медиа-файлы (изображения, видео). |
| `tags` | String | Нет | Теги одной строкой (формат зависит от реализации UI, обычно CSV). |
| `status` | String | Нет | Статус публикации (`DRAFT`, `SCHEDULED`, `PUBLISHED`). По умолчанию `DRAFT`. |

**Пример:**
```json
{
  "projectId": "uuid-project-id",
  "title": "Новости дня",
  "content": "Сегодня произошло важное событие...",
  "mediaFiles": ["https://example.com/image.jpg"],
  "tags": "news,tech",
  "status": "DRAFT"
}
```

### Планирование публикации (Рассылка)
Создает посты для конкретных каналов на основе уже созданной публикации.

**Endpoint:** `POST /api/v1/publications/:id/posts`

**Тело запроса (JSON):**

| Поле | Тип | Обязательно | Описание |
|---|---|---|---|
| `channelIds` | String[] | Да | Массив ID каналов, в которые нужно отправить пост. |
| `scheduledAt` | ISO Date | Нет | Дата и время запланированной публикации. Если не указано, создаются черновики. |

**Пример:**
```json
{
  "channelIds": ["uuid-channel-1", "uuid-channel-2"],
  "scheduledAt": "2024-01-01T12:00:00Z"
}
```

---

## API Автоматизации

Эндпоинты, используемые фоновыми воркерами или скриптами автоматизации для обработки очереди публикаций.

### Получение списка ожидающих постов
Получает список постов, готовых к публикации (статус SCHEDULED, время публикации наступило).

**Endpoint:** `GET /api/v1/publications/automation/pending`

**Параметры URL:**
- `limit` (int, default: 10): Максимальное количество постов.
- `lookback` (int, default: 60): Окно поиска в прошлом (минуты), чтобы не забирать слишком старые "зависшие" посты бесконечно.

**Ответ:** Массив объектов Post.

### Захват поста (Claim)
"Блокирует" пост для обработки конкретным воркером, чтобы избежать дублирования публикации. Атомарная операция.

**Endpoint:** `POST /api/v1/publications/automation/:id/claim`

### Обновление статуса поста
Обновляет статус поста после попытки публикации (успех или ошибка).

**Endpoint:** `PATCH /api/v1/publications/automation/:id/status`

**Тело запроса (JSON):**

| Поле | Тип | Обязательно | Описание |
|---|---|---|---|
| `status` | String | Да | Новый статус: `PUBLISHED` или `FAILED`. |
| `error` | String | Нет | Описание ошибки, если публикация не удалась. |

**Пример:**
```json
{
  "status": "PUBLISHED"
}
```
или
```json
{
  "status": "FAILED",
  "error": "Timeout connecting to Telegram API"
}
```

---

## Примеры использования

### n8n: Создание поста из Telegram бота

1. **Webhook Node**: Получает сообщение от Telegram бота
2. **HTTP Request Node**: 
   - Method: POST
   - URL: `https://your-domain.com/api/v1/posts`
   - Headers:
     - `x-api-key`: `your-api-token`
     - `Content-Type`: `application/json`
   - Body:
     ```json
     {
       "channelId": "{{$json.channelId}}",
       "content": "{{$json.message}}",
       "status": "SCHEDULED",
       "scheduledAt": "{{$json.scheduledTime}}"
     }
     ```
